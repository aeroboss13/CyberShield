#!/bin/bash

# Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… CyberShield
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./scripts/backup-db.sh

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
else
    echo -e "${RED}âŒ Ð¤Ð°Ð¹Ð» .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½${NC}"
    exit 1
fi

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð±ÑÐºÐ°Ð¿Ð¾Ð² ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
BACKUP_DIR="./backups"
mkdir -p $BACKUP_DIR

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð¼Ñ Ñ„Ð°Ð¹Ð»Ð° Ñ Ð´Ð°Ñ‚Ð¾Ð¹ Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½ÐµÐ¼
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$BACKUP_DIR/cybershield_backup_$TIMESTAMP.sql"

echo -e "${BLUE}ðŸ“¦ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…...${NC}"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
PGPASSWORD=secure_password_here pg_dump -h localhost -U pabit_user -d pabit_db > $BACKUP_FILE

if [ $? -eq 0 ]; then
    # Ð¡Ð¶Ð¸Ð¼Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
    gzip $BACKUP_FILE
    BACKUP_FILE="${BACKUP_FILE}.gz"
    
    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°
    SIZE=$(du -h $BACKUP_FILE | cut -f1)
    
    echo -e "${GREEN}âœ… Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!${NC}"
    echo -e "${GREEN}ðŸ“ Ð¤Ð°Ð¹Ð»: $BACKUP_FILE${NC}"
    echo -e "${GREEN}ðŸ’¾ Ð Ð°Ð·Ð¼ÐµÑ€: $SIZE${NC}"
    
    # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹ (ÑÑ‚Ð°Ñ€ÑˆÐµ 7 Ð´Ð½ÐµÐ¹)
    find $BACKUP_DIR -name "cybershield_backup_*.sql.gz" -mtime +7 -delete
    echo -e "${BLUE}ðŸ§¹ Ð£Ð´Ð°Ð»ÐµÐ½Ñ‹ Ð±ÑÐºÐ°Ð¿Ñ‹ ÑÑ‚Ð°Ñ€ÑˆÐµ 7 Ð´Ð½ÐµÐ¹${NC}"
else
    echo -e "${RED}âŒ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸${NC}"
    exit 1
fi

# ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð±ÑÐºÐ°Ð¿Ð¾Ð²
echo -e "\n${BLUE}ðŸ“‹ Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¿Ð¸Ð¸:${NC}"
ls -lh $BACKUP_DIR/cybershield_backup_*.sql.gz 2>/dev/null | awk '{print $9, "("$5")"}'



