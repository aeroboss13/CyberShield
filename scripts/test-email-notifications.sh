#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/test-email-notifications.sh

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}üìß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π CyberShield${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
if ! curl -s http://localhost:5000/api/health > /dev/null; then
    echo -e "${RED}‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä —Å–Ω–∞—á–∞–ª–∞.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω${NC}"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ email
echo -e "${BLUE}üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ email:${NC}"
if grep -q "EMAIL_USER=p.bardin2017@yandex.ru" .env; then
    echo -e "${GREEN}‚úÖ EMAIL_USER –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
else
    echo -e "${RED}‚ùå EMAIL_USER –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
fi

if grep -q "EMAIL_PASS=" .env; then
    echo -e "${YELLOW}‚ö†Ô∏è  EMAIL_PASS –Ω–∞–π–¥–µ–Ω (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)${NC}"
else
    echo -e "${RED}‚ùå EMAIL_PASS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω${NC}"
fi

echo ""

# –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo -e "${BLUE}üß™ –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è${NC}"
echo "–°–æ–∑–¥–∞—é —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è..."

response=$(curl -s -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"emailtest","email":"emailtest@example.com","password":"TestPassword123!","name":"Email Test User"}')

if [[ $? -eq 0 ]]; then
    echo -e "${GREEN}‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω${NC}"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É p.bardin2017@yandex.ru –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è${NC}"
fi

echo ""

# –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ email
echo -e "${BLUE}üß™ –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ email${NC}"
echo "–ü—Ä–æ–≤–µ—Ä—è—é –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π..."

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
if pm2 logs cybershield --nostream --lines 20 | grep -q "üìß.*email sent"; then
    echo -e "${GREEN}‚úÖ Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è${NC}"
    echo ""
    echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ email-–ª–æ–≥–∏:"
    pm2 logs cybershield --nostream --lines 10 | grep -E "üìß|Email|email" | tail -5
else
    echo -e "${YELLOW}‚ö†Ô∏è  Email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö${NC}"
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "1. EMAIL_PASS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–Ω—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Yandex)"
    echo "2. –ü—Ä–æ–±–ª–µ–º—ã —Å SMTP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º"
    echo "3. Email-—Å–µ—Ä–≤–∏—Å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
fi

echo ""

# –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã)
echo -e "${BLUE}üß™ –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –ë–î${NC}"
echo "–ü—Ä–æ–≤–µ—Ä—è—é, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î..."

notification_count=$(PGPASSWORD=secure_password_here psql -h localhost -U pabit_user -d pabit_db -c "SELECT COUNT(*) FROM notifications;" -t | xargs)

if [[ $notification_count -eq 0 ]]; then
    echo -e "${GREEN}‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è  –í –ë–î –Ω–∞–π–¥–µ–Ω–æ $notification_count —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π${NC}"
    echo "–≠—Ç–æ —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –Ω–æ–≤—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ email"
fi

echo ""

# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
echo -e "${BLUE}üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ email:${NC}"
echo ""
echo "1. –î–ª—è —Ä–∞–±–æ—Ç—ã email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Yandex:"
echo "   ‚Ä¢ –ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Yandex ID"
echo "   ‚Ä¢ –í–∫–ª—é—á–∏—Ç–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é"
echo "   ‚Ä¢ –°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
echo "   ‚Ä¢ –ó–∞–º–µ–Ω–∏—Ç–µ 'your_app_password_here' –≤ .env –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å"
echo ""
echo "2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
echo "   pm2 restart cybershield"
echo ""
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É p.bardin2017@yandex.ru –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
echo ""

echo -e "${GREEN}‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
echo ""
echo -e "${BLUE}üí° –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ email-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:${NC}"
echo "pm2 logs cybershield | grep -E 'üìß|Email|email'"
